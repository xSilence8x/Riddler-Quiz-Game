{% extends "base.html" %}

{% load static %}

{% block title %}
Kvíz
{% endblock %}

{% block content %}   
{% if user.is_authenticated%}    

    <div class="container ">
    
    <div align="right " id="displaytimer"><b>Timer: 0 seconds</b></div>
    
    <form id="quizForm" method='post' action=''>
        {% csrf_token %}
        {% for q in questions %}
        <div class="question{% if forloop.first %} active{% endif %}" id="question_{{ q.id }}">
            <div class="form-group">
                <label for="user_answer_{{ q.id }}">{{ q.question }}</label>
                <input type="text" id="user_answer_{{ q.id }}" name="user_answer_{{ q.id }}" class="form-control" required autocomplete="off">
            </div>
        
            <button type="button" class="showHintBtn" data-question-id="{{ q.id }}">Nápověda</button>
            <div class="hint" id="hint_{{ q.id }}" style="display: none;">{{ q.hint }}</div>
            <br>
        </div>
        {% endfor %}
        <br>
        <input id='timer' type='hidden' name="timer" value="">
        <input id='hintButtonClickCount' type='hidden' name="hintButtonClickCount" value="">
        <br>
        <button type="button" class="btn btn-primary" id="nextButton">Další hádanka</button>
        <button type="submit" class="btn btn-primary" id="submitButton" style="display: none;">Poslat odpovědi</button>
    </form>
    <div class="container">
        <p>
            <a href="{% url 'home' %}">Ukončit kvíz</a>
        </p>
    </div>
    {% block script %}
        <script>
            {% comment %} window.onbeforeunload = function() {
                // Set expected_token session key to None
                var xhr = new XMLHttpRequest();
                xhr.open("POST", "{% url 'invalid_token' %}", true);
                xhr.setRequestHeader("X-CSRFToken", "{{ csrf_token }}");
                xhr.send();
            }; {% endcomment %}
            
            let hintButtonClickCount = 0;
            var clickCount = document.getElementById("hintButtonClickCount")
            clickCount.value = hintButtonClickCount;

            document.addEventListener('DOMContentLoaded', function() {
                // Initially hide all question elements
                const questions = document.querySelectorAll('.question');
                questions.forEach(function(question) {
                    question.style.display = 'none';
                });
            
                // Show the first question initially
                const firstQuestion = document.querySelector('.question.active');
                if (firstQuestion) {
                    firstQuestion.style.display = 'block';
                }
            
                // Function to toggle visibility of questions
                function toggleQuestions(activeQuestion) {
                    questions.forEach(function(question) {
                        if (question === activeQuestion) {
                            question.style.display = 'block';
                        } else {
                            question.style.display = 'none';
                        }
                    });
                }
                document.querySelectorAll('.showHintBtn').forEach(function(button) {
                    button.addEventListener('click', function() {
                        t+=5;
                        hintButtonClickCount++;
                        clickCount.value = hintButtonClickCount;
                        var questionId = this.getAttribute('data-question-id');
                        var hintElement = document.getElementById('hint_' + questionId);
                        hintElement.style.display = 'block';
                    });
                });
            
                // Event listener for the next button
                const nextButton = document.getElementById('nextButton');
                nextButton.addEventListener('click', function() {
                    const activeQuestion = document.querySelector('.question.active');
                    const nextQuestion = activeQuestion.nextElementSibling;

                    // Check if the input field of the active question is empty
                    const inputField = activeQuestion.querySelector('input[type="text"]');
                    if (inputField && inputField.value.trim() === '') {
                        alert('Musíš zadat odpověď!');
                        return; // Stop execution if input is empty
                    }
                    if (nextQuestion && nextQuestion.classList.contains('question')) {
                        activeQuestion.classList.remove('active');
                        nextQuestion.classList.add('active');
                        toggleQuestions(nextQuestion);

                        if (!nextQuestion.nextElementSibling || !nextQuestion.nextElementSibling.classList.contains('question')) {
                            nextButton.style.display = 'none'; // Hide next button
                            document.getElementById('submitButton').style.display = 'block'; // Show submit button
                        }
                    }
                });
            });
            
            const timer=document.getElementById('displaytimer')
            const inputtag = document.getElementById('timer')

            t=0
            setInterval(()=>{
                t+=1
                timer.innerHTML ="<b>Timer: " +t+" seconds</b>"
                inputtag.value = t

                if (t > 20) {
                    document.getElementById("quizForm").submit();
                }
            },1000)
        

        </script>
    {% endblock script %}
    
    </div>
{% else %}
    <div class="container ">
        <p>
            Pro spuštění kvízu se musíš <a href="{% url 'login' %}">přihlásit</a>!
        <p>
        <p>
            Nemáš účet? Nevadí. <a href="{% url 'register' %}">Zaregistruj se.</a>
        </p>
    </div>
{% endif %}
{% endblock %}